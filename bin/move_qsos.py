# SY 22/5/19
# Use alphas generated by CAMB to move qsos and write the new positions to
# 100 individual qso catalogues.

import numpy as np
import healpy as hp
from astropy.table import Table, join
from kappa_lya import *

#-- Set resolution for lensing maps
nside=1024
npix=nside**2*12

#-- Create kappa power spectrum
theory = Theory()
ell, cell = theory.get_cl_kappa(2.1, kmax=100., nz=100, lmax=10000)

#-- Make maps
for i in range(1,101):
    seed=i
    np.random.seed(seed)
    kappa = create_gaussian_kappa(ell, cell, nside=nside, seed=seed)

    #-- Amend DEC and RA for each qso by the bend angles (alphas)
    t = Table.read('zcat_desi_drq.fits')
    theta_lens, phi_lens = kappa.displace_objects \
               (np.pi/2-np.radians(t['DEC']), np.radians(t['RA']))

    #-- Rename RA & DEC columns which hold unlensed position of qso
    t.rename_column('DEC', 'DEC0')
    t.rename_column('RA', 'RA0')

    #-- Add in new columns for lensed position of qso
    t['DEC'] = np.degrees(np.pi/2-theta_lens)
    t['RA'] = np.degrees(phi_lens)

    t.write('zcats/zcat_desi_drq_lensed_{}.fits'.format(i), format='fits')


